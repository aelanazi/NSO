# NSO
PBB-EVPN Usage:

This package contains three services types:
- E-LINE
- E-LAN
- E-Tree
The difference between those services is mainly the handling of the Route-Target behavior in the YANG and Python mapping Logic. i.e when selecting E-Line service the RT-Import and export is restricted to max 1 element and this is copied to all attachment circuits. In the case of E-LAN, you can have multiple RTs which will be configured on all attachment circuits. In the last case when using E-Tree there are two types RT one type for each HUB allowing multiple HUBs for redundancy and one type used for spokes, python will automatically import the HUB's RT types to all spokes and HUBs will import automatically all spokes RT's allowing E-Tree topology.

Future moreFurthermore, each service type has multiple interfaces to choose from:
- GigabitEthernet
- TenGigabitEthernet
- Bundle-Ethernet

In the case of Bundle, the sub-interfaces can be TenGig or Gig interfaces. When selecting Bundle-Ethernet or LACP Protected mode the Bundle ID is auto-generated by looking into the PE device for the next available BE ID to be used. This is made possible with python function called "get_bundle_id" in the main.py file.



Also, there is support for the following topology types:
- None # meaning single connection CE to PE
- Protected # meaning LACP Bundle-Interface connection from CE to PE 
- Dual-PE # meaning V-Shaped multiple connections connection from CE to dual-PE which will utilize ESI to support Active/Standby PE      scenario.



Here are some example of how to deploy the services through NSO CLI:

The following uses E-Tree with 3 attachemnt circuit one Root and two leaves, HUB uses Dual-PE topology but service is only depolied on single PE:

services pbb-evpn 1001
 service-type  etree
 evi           49001
 customer-name EccoTel
 etree
  link 1
   edge-i-sid       4900001
   ce-type          hub
   hub-route-target 100:1
   pe-device        pre-region2-pe1
   svlan-id         430
   pe-port pe-gig-port 0/1/0/18
   nni-redundancy   Dual-PE
   Dual-PE esi 0300.4900.fff1

  !
  link 2
   edge-i-sid         4900001
   ce-type            spoke
   spoke-route-target 200:1
   pe-device          devXR2
   svlan-id           3030
   pe-port pe-gig-port 0/4
  !
  link 3
   edge-i-sid 4900003
   ce-type    spoke
   spoke-route-target 300:1
   pe-device  rd-region1-pe2
   svlan-id   40
   pe-port pe-gig-port 0/1/0/27
 !
!


CLI native output:

nsoadmin@ncs(config)# commit dry-run outformat native
native {
    device {
        name devXR2
        data interface GigabitEthernet 0/4
              description "[UNI-N] [$CEDD Name] [Management]"
              mtu           9022
              negotiation auto
              load-interval 30
             exit
             interface GigabitEthernet 0/4.199 l2transport
              description "[UNI-N] [$CEDD Name] [Management]"
              encapsulation dot1q 199
              rewrite ingress tag pop 1 symmetric
             exit
             interface GigabitEthernet 0/4.3030 l2transport
              encapsulation dot1q 3030
              rewrite ingress tag pop 1 symmetric
              l2protocol cpsv tunnel
             exit
             evpn
              evi 49001
               bgp
                rd 65004:49001
                route-target import 100:1
                route-target export 200:1
               exit
              exit
             exit
             l2vpn
              bridge group PBB_EVPN_CORE
               bridge-domain PBB_EVPN_CORE-49001
                pbb core
                 evpn evi 49001
                exit
               exit
              exit
              bridge group PBB_EVPN_EDGE
               bridge-domain PBB_EVPN_EDGE-49001
                mac
                 limit
                  maximum 4095
                 exit
                exit
                interface GigabitEthernet0/4.3030
                exit
                pbb edge i-sid 4900001 core-bridge PBB_EVPN_CORE-49001
                exit
               exit
              exit
             exit
    }
    device {
        name pre-region2-pe1
        data interface GigabitEthernet 0/1/0/18
              description   [UNI-N] [$CEDD Name] [Management]
              mtu           9022
              negotiation auto
              load-interval 30
             exit
             interface GigabitEthernet 0/1/0/18.199 l2transport
              description [UNI-N] [$CEDD Name] [Management]
              encapsulation dot1q 199
              rewrite ingress tag pop 1 symmetric
             exit
             interface GigabitEthernet 0/1/0/18.430 l2transport
              encapsulation dot1q 430
              rewrite ingress tag pop 1 symmetric
              l2protocol cpsv tunnel
             exit
             evpn
              evi 49001
               bgp
                rd 65004:49001
                route-target import 200:1
                route-target import 300:1
                route-target export 100:1
               exit
              exit
             exit
             l2vpn
              bridge group PBB_EVPN_CORE
               bridge-domain PBB_EVPN_CORE-49001
                pbb core
                 evpn evi 49001
                exit
               exit
              exit
              bridge group PBB_EVPN_EDGE
               bridge-domain PBB_EVPN_EDGE-49001
                mac
                 limit
                  maximum 4095
                 exit
                exit
                interface GigabitEthernet0/1/0/18.430
                exit
                pbb edge i-sid 4900001 core-bridge PBB_EVPN_CORE-49001
                exit
               exit
              exit
             exit
    }
    device {
        name rd-region1-pe2
        data interface GigabitEthernet 0/1/0/27
              description   [UNI-N] [$CEDD Name] [Management]
              mtu           9022
              negotiation auto
              load-interval 30
             exit
             interface GigabitEthernet 0/1/0/27.199 l2transport
              description [UNI-N] [$CEDD Name] [Management]
              encapsulation dot1q 199
              rewrite ingress tag pop 1 symmetric
             exit
             interface GigabitEthernet 0/1/0/27.40 l2transport
              encapsulation dot1q 40
              rewrite ingress tag pop 1 symmetric
              l2protocol cpsv tunnel
             exit
             evpn
              evi 49001
               bgp
                rd 65004:49001
                route-target import 100:1
                route-target export 300:1
               exit
              exit
             exit
             l2vpn
              bridge group PBB_EVPN_CORE
               bridge-domain PBB_EVPN_CORE-49001
                pbb core
                 evpn evi 49001
                exit
               exit
              exit
              bridge group PBB_EVPN_EDGE
               bridge-domain PBB_EVPN_EDGE-49001
                mac
                 limit
                  maximum 4095
                 exit
                exit
                interface GigabitEthernet0/1/0/27.40
                exit
                pbb edge i-sid 4900003 core-bridge PBB_EVPN_CORE-49001
                exit
               exit
              exit
             exit
    }
}
nsoadmin@ncs(config)# 


E-Line configurations examples, deploying 10G and 1G interfaces in a Protected LACP Topology:


nsoadmin@ncs(config)# load merge terminal            
Loading.
services pbb-evpn 101
 service-type  eline
 evi           49001
 customer-name Test1
 eline
  route-target rt-export 1:1
  route-target rt-export 2:1
  route-target rt-import 1:1
  route-target rt-import 2:1
  link 1
   edge-i-sid     4900001
   pe-device      pre-region2-pe1
   svlan-id       300
   interface-type TenGigabitEthernet
   pe-port
    pe-tengig-port 0/0/0/4
   !
   nni-redundancy Protected
   Bundle-Ether pe-port 0/1/0/18
   Bundle-Ether pe-port 0/1/0/19
  !
  link 2
   edge-i-sid     4900002
   pe-device      devXR2
   svlan-id       300
   pe-port
    pe-gig-port 0/1
   !
   nni-redundancy Protected
   Bundle-Ether pe-port 0/2
   Bundle-Ether pe-port 0/3
  !
 !
!

0 bytes parsed in 2.72 sec (0 bytes/sec)
nsoadmin@ncs(config)# commit dry-run outformat native 
native {
    device {
        name devXR2
        data interface Bundle-Ether 1
              description "Test"
             exit
             interface Bundle-Ether 1.199
              description "MGMT"
             exit
             interface Bundle-Ether 1.300 l2transport
              description "[UNI-N] [$CEDD Name] [Test1] [$Kundennummer($Service-ID)]"
              encapsulation dot1q 300
              rewrite ingress tag pop 1 symmetric
              l2protocol cpsv tunnel
             exit
             interface GigabitEthernet 0/1
              bundle id 1
             exit
             interface GigabitEthernet 0/2
              bundle id 1 mode active
             exit
             interface GigabitEthernet 0/3
              bundle id 1 mode active
             exit
             evpn
              evi 49001
               bgp
                rd 65004:49001
                route-target import 1:1
                route-target import 2:1
                route-target export 1:1
                route-target export 2:1
               exit
              exit
             exit
             l2vpn
              bridge group PBB_EVPN_CORE
               bridge-domain PBB_EVPN_CORE-49001
                pbb core
                 evpn evi 49001
                exit
               exit
              exit
              bridge group PBB_EVPN_EDGE
               bridge-domain PBB_EVPN_EDGE-49001
                mac
                 limit
                  maximum 4095
                 exit
                exit
                interface Bundle-Ether1.300
                exit
                pbb edge i-sid 4900002 core-bridge PBB_EVPN_CORE-49001
                exit
               exit
              exit
             exit
    }
    device {
        name pre-region2-pe1
        data interface Bundle-Ether 2
              description Test
             exit
             interface Bundle-Ether 2.199
              description MGMT
             exit
             interface Bundle-Ether 2.300 l2transport
              description [UNI-N] [$CEDD Name] [Test1] [$Kundennummer($Service-ID)]
              encapsulation dot1q 300
              rewrite ingress tag pop 1 symmetric
              l2protocol cpsv tunnel
             exit
             interface TenGigE 0/0/0/4
              bundle id 2
             exit
             interface TenGigE 0/1/0/18
              bundle id 2
             exit
             interface TenGigE 0/1/0/19
              bundle id 2
             exit
             evpn
              evi 49001
               bgp
                rd 65004:49001
                route-target import 1:1
                route-target import 2:1
                route-target export 1:1
                route-target export 2:1
               exit
              exit
             exit
             l2vpn
              bridge group PBB_EVPN_CORE
               bridge-domain PBB_EVPN_CORE-49001
                pbb core
                 evpn evi 49001
                exit
               exit
              exit
              bridge group PBB_EVPN_EDGE
               bridge-domain PBB_EVPN_EDGE-49001
                mac
                 limit
                  maximum 4095
                 exit
                exit
                interface Bundle-Ether2.300
                exit
                pbb edge i-sid 4900001 core-bridge PBB_EVPN_CORE-49001
                exit
               exit
              exit
             exit
    }
}
nsoadmin@ncs(config)# 

E-LAN configurations examples, deploying 10G and 1G interfaces in a Protected LACP Topology:

nsoadmin@ncs(config)# load merge terminal            
Loading.
services pbb-evpn 102
 service-type  elan
 evi           49002
 customer-name Test2
  elan route-target rt-export 3:1
  elan route-target rt-export 3:2
  elan route-target rt-import 3:1
  elan route-target rt-import 3:2
  elan link 1
   edge-i-sid     4900003
   pe-device      pre-region2-pe1
   svlan-id       300
   interface-type TenGigabitEthernet
   pe-port
    pe-tengig-port 0/0/0/4
   !
   nni-redundancy Protected
   Bundle-Ether pe-port 0/1/0/18
   Bundle-Ether pe-port 0/1/0/19
  !
  elan link 2
   edge-i-sid     4900004
   pe-device      devXR2
   svlan-id       300
   pe-port
    pe-gig-port 0/1
   !
   nni-redundancy Protected
   Bundle-Ether pe-port 0/2
   Bundle-Ether pe-port 0/3
  !
 !
!

0 bytes parsed in 2.64 sec (0 bytes/sec)
nsoadmin@ncs(config)# commit dry-run outformat native
native {
    device {
        name devXR2
        data interface Bundle-Ether 1
              description "Test"
             exit
             interface Bundle-Ether 1.199
              description "MGMT"
             exit
             interface Bundle-Ether 1.300 l2transport
              description "[UNI-N] [$CEDD Name] [Test2] [$Kundennummer($Service-ID)]"
              encapsulation dot1q 300
              rewrite ingress tag pop 1 symmetric
              l2protocol cpsv tunnel
             exit
             interface GigabitEthernet 0/1
              bundle id 1
             exit
             interface GigabitEthernet 0/2
              bundle id 1 mode active
             exit
             interface GigabitEthernet 0/3
              bundle id 1 mode active
             exit
             evpn
              evi 49002
               bgp
                rd 65004:49002
                route-target import 3:1
                route-target import 3:2
                route-target export 3:1
                route-target export 3:2
               exit
              exit
             exit
             l2vpn
              bridge group PBB_EVPN_CORE
               bridge-domain PBB_EVPN_CORE-49002
                pbb core
                 evpn evi 49002
                exit
               exit
              exit
              bridge group PBB_EVPN_EDGE
               bridge-domain PBB_EVPN_EDGE-49002
                mac
                 limit
                  maximum 4095
                 exit
                exit
                interface Bundle-Ether0/1.300
                exit
                pbb edge i-sid 4900004 core-bridge PBB_EVPN_CORE-49002
                exit
               exit
              exit
             exit
    }
    device {
        name pre-region2-pe1
        data interface Bundle-Ether 2
              description Test
             exit
             interface Bundle-Ether 2.199
              description MGMT
             exit
             interface Bundle-Ether 2.300 l2transport
              description [UNI-N] [$CEDD Name] [Test2] [$Kundennummer($Service-ID)]
              encapsulation dot1q 300
              rewrite ingress tag pop 1 symmetric
              l2protocol cpsv tunnel
             exit
             interface TenGigE 0/0/0/4
              bundle id 2
             exit
             interface TenGigE 0/1/0/18
              bundle id 2
             exit
             interface TenGigE 0/1/0/19
              bundle id 2
             exit
             evpn
              evi 49002
               bgp
                rd 65004:49002
                route-target import 3:1
                route-target import 3:2
                route-target export 3:1
                route-target export 3:2
               exit
              exit
             exit
             l2vpn
              bridge group PBB_EVPN_CORE
               bridge-domain PBB_EVPN_CORE-49002
                pbb core
                 evpn evi 49002
                exit
               exit
              exit
              bridge group PBB_EVPN_EDGE
               bridge-domain PBB_EVPN_EDGE-49002
                mac
                 limit
                  maximum 4095
                 exit
                exit
                interface Bundle-Ether0/0/0/4.300
                exit
                pbb edge i-sid 4900003 core-bridge PBB_EVPN_CORE-49002
                exit
               exit
              exit
             exit
    }
}
nsoadmin@ncs(config)# 
